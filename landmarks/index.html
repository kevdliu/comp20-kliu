<!DOCTYPE html>

<html>

	<head>
		<title>Historic Landmarks</title>
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
		<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=true"></script>
		<link rel="stylesheet" href="geolocation_map_style.css" />
		
		<script>
			var selfMarker = "https://maps.google.com/mapfiles/kml/shapes/arrow.png";
			var landmarkMarker = "https://maps.google.com/mapfiles/kml/shapes/picnic.png";
		
			var request = new XMLHttpRequest();
			
			var people = new Array();
			var landmarks = new Array();
			var infoWindow = new google.maps.InfoWindow(), marker, i;
			var map;
			var myOptions = {
				zoom: 13,
				center: people[0],
				mapTypeId: google.maps.MapTypeId.ROADMAP
			};
			
			function init(){
				map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
				getMyLocation();	
			}
			
			function getMyLocation() {
				if (navigator.geolocation) { // the navigator.geolocation object is supported on your browser
					navigator.geolocation.getCurrentPosition(function(position) {
						var me = {
							"lat": position.coords.latitude,
							"lng": position.coords.longitude,
							"login": "PATRICK_PUGH"
						};
						people.push(me);
						
						// pan to current location
						map.panTo(me);
						
						renderMap();
					});
				} else {
					alert("Geolocation is not supported by your web browser.  What a shame!");
				}
			}

			function renderMap(){
				// get data for other people and landmarks
				getClassData(function(classData) {
					for (i = 0; i < classData.people.length; i++) {
						people.push(classData.people[i]);
					}
					
					console.log(classData);
					for (i = 0; i < classData.landmarks.length; i++) {
						landmarks.push(classData.landmarks[i]);
					}
					
					addPeopleMarkers();
					addLandmarkMarkers();
				});
			}
			
			function addPeopleMarkers() {
				var distance = 2; // only getting landmarks within a mile anway so 2 is enough for the search
				var landmarkName = "";
				var landmarkIndex = 0;
					
				for(i = 0; i < people.length; i++) {
					// create marker location
					var position = new google.maps.LatLng(people[i].lat, people[i].lng);
					
					// if marker is not self, calculate and display distance
					if (i != 0) {
						distance = getDistance(people[0].lat, people[0].lng, people[i].lat, people[i].lng);
					} else {
						// if marker is self, find and display closest landmark
						for (x = 0; x < landmarks.length; x++) {
							var dLandmark = getDistance(people[0].lat, people[0].lng, landmarks[x].lat, landmarks[x].lng);
							if (dLandmark < distance) {
								distance = dLandmark;
								landmarkName = landmarks[x].properties.Location_Name;
								landmarkIndex = x;
							}
						}
					}
		
					// create marker
					marker = new google.maps.Marker({
						position: position,
						map: map,
						icon: (i == 0 ? selfMarker : null),
						title: people[i].login
					});
					
					// open info window on click of marker
					google.maps.event.addListener(marker, 'click', (function(marker, i) {
						return function() {
							var content = (i == 0 ? ("Closest Landmark: " + landmarkName + "<br />" + "Distance: " + distance) : (people[i].login + "<br /> Distance: " + distance));
							infoWindow.setContent(content);
							infoWindow.open(map, marker);
						}
					})(marker, i));
				}
				
				// after displaying all markers, display polyline between self and closest landmark
				var flightPlanCoordinates = [
					{lat: people[0].lat, lng: people[0].lng},
					{lat: landmarks[landmarkIndex].lat, lng: landmarks[landmarkIndex].lng}
				];
				var flightPath = new google.maps.Polyline({
					path: flightPlanCoordinates,
					geodesic: true,
					strokeColor: '#FF0000',
					strokeOpacity: 1.0,
					strokeWeight: 2
				});

				flightPath.setMap(map);
			}
			
			function addLandmarkMarkers() {
				for(i = 0; i < landmarks.length; i++) {
					// create marker location
					var position = new google.maps.LatLng(landmarks[i].lat, landmarks[i].lng);
		
					// create marker
					marker = new google.maps.Marker({
						position: position,
						map: map,
						icon: landmarkMarker,
						title: landmarks[i].properties.Location_Name
					});
					
					// open info window on click of marker
					google.maps.event.addListener(marker, 'click', (function(marker, i) {
						return function() {
							var content = landmarks[i].properties.Location_Name + "<br />" + landmarks[i].properties.Details;
							infoWindow.setContent(content);
							infoWindow.open(map, marker);
						}
					})(marker, i));
				}
			}
			
			function getClassData(callback) {
				var http = new XMLHttpRequest();
				var url = "https://defense-in-derpth.herokuapp.com/sendLocation";
				var params = "login=PATRICK_PUGH&lat=" + people[0].lat + "&lng=" + people[0].lat;
				http.open("POST", url, true);

				//Send the proper header information along with the request
				http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
				http.setRequestHeader("Content-length", params.length);
				http.setRequestHeader("Connection", "close");

				http.onreadystatechange = function() {//Call a function when the state changes.
					if(http.readyState == 4 && http.status == 200) {
						var classData = JSON.parse(http.responseText);
						callback(classData);
					}
				}
				http.send(params);
			}
			
			// Credit to http://stackoverflow.com/questions/14560999/using-the-haversine-formula-in-javascript
			function getDistance(latA, lngA, latB, lngB) {
				var R = 6371; // Radius of the earth in km
				var dLat = deg2rad(latB - latA);
				var dLng = deg2rad(lngB - lngA); 
				var a = 
					Math.sin(dLat / 2) * Math.sin(dLat / 2) +
					Math.cos(deg2rad(latA)) * Math.cos(deg2rad(latB)) * 
					Math.sin(dLng / 2) * Math.sin(dLng / 2); 
				var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)); 
				var d = R * c * 0.621371; // convert to miles
				return d;
			}

			function deg2rad(deg) {
				return deg * (Math.PI / 180);
			}
		</script>
	</head>
	
	<body onload="init()">
		<div id="map_canvas"></div>
	</body>
</html>
